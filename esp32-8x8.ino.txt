#include <WiFi.h>
#include <WebServer.h>
#include <ArduinoJson.h>
#include <SPIFFS.h>
#include <time.h>

#define RELAY_COUNT 8
#define SCHEDULES_PER_RELAY 8
#define ACTIVE_LEVEL LOW   // change to HIGH if your relay is active-high

const char* ssid = "YOUR_WIFI_NAME";
const char* password = "YOUR_WIFI_PASSWORD";

WebServer server(80);

int relayPins[RELAY_COUNT] = {2, 4, 5, 12, 13, 14, 27, 26};

struct Schedule {
  bool enabled;
  uint8_t hour;
  uint8_t minute;
  bool state;
};

Schedule schedules[RELAY_COUNT][SCHEDULES_PER_RELAY];
int lastMinute = -1;

// ---------------- FILE SYSTEM ----------------
void loadSchedules() {
  if (!SPIFFS.exists("/schedules.json")) return;

  File f = SPIFFS.open("/schedules.json", "r");
  StaticJsonDocument<4096> doc;
  deserializeJson(doc, f);
  f.close();

  for (int r = 0; r < RELAY_COUNT; r++) {
    for (int s = 0; s < SCHEDULES_PER_RELAY; s++) {
      schedules[r][s].enabled = doc[r][s]["en"];
      schedules[r][s].hour    = doc[r][s]["h"];
      schedules[r][s].minute  = doc[r][s]["m"];
      schedules[r][s].state   = doc[r][s]["st"];
    }
  }
}

void saveSchedules() {
  StaticJsonDocument<4096> doc;

  for (int r = 0; r < RELAY_COUNT; r++) {
    for (int s = 0; s < SCHEDULES_PER_RELAY; s++) {
      doc[r][s]["en"] = schedules[r][s].enabled;
      doc[r][s]["h"]  = schedules[r][s].hour;
      doc[r][s]["m"]  = schedules[r][s].minute;
      doc[r][s]["st"] = schedules[r][s].state;
    }
  }

  File f = SPIFFS.open("/schedules.json", "w");
  serializeJson(doc, f);
  f.close();
}

// ---------------- TIME ----------------
void initTime() {
  configTime(8 * 3600, 0, "pool.ntp.org"); // GMT+8 (PH)
}

// ---------------- RELAY ----------------
void setRelay(int relay, bool state) {
  digitalWrite(relayPins[relay], state ? ACTIVE_LEVEL : !ACTIVE_LEVEL);
}

// ---------------- WEB UI ----------------
String htmlPage() {
  String page =
  "<!DOCTYPE html><html><head><meta name='viewport' content='width=device-width'>"
  "<style>body{font-family:Arial}table{border-collapse:collapse}"
  "td,th{border:1px solid #aaa;padding:5px}</style></head><body>"
  "<h2>ESP32 Relay Scheduler</h2><form action='/save' method='post'>";

  for (int r = 0; r < RELAY_COUNT; r++) {
    page += "<h3>Relay " + String(r+1) + "</h3><table>";
    page += "<tr><th>Enable</th><th>Time</th><th>Action</th></tr>";

    for (int s = 0; s < SCHEDULES_PER_RELAY; s++) {
      page += "<tr><td><input type='checkbox' name='e"+String(r)+"_"+String(s)+"' ";
      if (schedules[r][s].enabled) page += "checked";
      page += "></td>";

      page += "<td><input type='time' name='t"+String(r)+"_"+String(s)+"' value='";
      char buf[6];
      sprintf(buf, "%02d:%02d", schedules[r][s].hour, schedules[r][s].minute);
      page += buf;
      page += "'></td>";

      page += "<td><select name='s"+String(r)+"_"+String(s)+"'>";
      page += schedules[r][s].state ? "<option selected>ON</option><option>OFF</option>"
                                    : "<option>ON</option><option selected>OFF</option>";
      page += "</select></td></tr>";
    }
    page += "</table>";
  }

  page += "<br><input type='submit' value='Save'></form></body></html>";
  return page;
}

void handleRoot() {
  server.send(200, "text/html", htmlPage());
}

void handleSave() {
  for (int r = 0; r < RELAY_COUNT; r++) {
    for (int s = 0; s < SCHEDULES_PER_RELAY; s++) {
      schedules[r][s].enabled = server.hasArg("e"+String(r)+"_"+String(s));

      String t = server.arg("t"+String(r)+"_"+String(s));
      schedules[r][s].hour = t.substring(0,2).toInt();
      schedules[r][s].minute = t.substring(3,5).toInt();

      schedules[r][s].state = server.arg("s"+String(r)+"_"+String(s)) == "ON";
    }
  }
  saveSchedules();
  server.sendHeader("Location","/");
  server.send(303);
}

// ---------------- LOOP ----------------
void checkSchedules() {
  struct tm timeinfo;
  if (!getLocalTime(&timeinfo)) return;

  if (timeinfo.tm_min == lastMinute) return;
  lastMinute = timeinfo.tm_min;

  for (int r = 0; r < RELAY_COUNT; r++) {
    for (int s = 0; s < SCHEDULES_PER_RELAY; s++) {
      if (schedules[r][s].enabled &&
          schedules[r][s].hour == timeinfo.tm_hour &&
          schedules[r][s].minute == timeinfo.tm_min) {
        setRelay(r, schedules[r][s].state);
      }
    }
  }
}

// ---------------- SETUP ----------------
void setup() {
  Serial.begin(115200);

  for (int i = 0; i < RELAY_COUNT; i++) {
    pinMode(relayPins[i], OUTPUT);
    digitalWrite(relayPins[i], !ACTIVE_LEVEL);
  }

  SPIFFS.begin(true);

  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) delay(500);

  initTime();
  loadSchedules();

  server.on("/", handleRoot);
  server.on("/save", HTTP_POST, handleSave);
  server.begin();
}

// ---------------- MAIN LOOP ----------------
void loop() {
  server.handleClient();
  checkSchedules();
}
